name: Pull Overleaf → Build PDF → Commit
on:
  workflow_dispatch: {}
  schedule:
    - cron: "0 */6 * * *"     # every 6 hours
  push:
    branches: [ main ]

permissions:
  contents: write

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          path: repo

      # 1) Fetch latest sources from Overleaf into ./artifacts (per action docs)
      - name: Fetch Overleaf sources
        uses: subhamx/overleaf_sync_with_git@master
        with:
          OVERLEAF_PROJECT_ID: ${{ secrets.OVERLEAF_PROJECT_ID }}
          OVERLEAF_COOKIE: ${{ secrets.OVERLEAF_COOKIE }}

      # 2) Copy fetched sources into the repo working tree
      - name: Prepare source tree
        run: |
          mkdir -p repo/overleaf_src
          cp -r artifacts/* repo/overleaf_src

      # 3) Build LaTeX (adjust root_file if your entry point isn't main.tex)
      - name: Build LaTeX
        uses: xu-cheng/latex-action@v3
        with:
          root_file: MLOps.tex
          working_directory: repo/overleaf_src

      # 4) Commit the PDF back to the repo (into docs/)
      - name: Commit PDF
        working-directory: repo
        run: |
          mkdir -p docs
          cp overleaf_src/*.pdf docs/ || true
          git config user.name  "github-actions"
          git config user.email "actions@github.com"
          git add docs/*.pdf || true
          git commit -m "CI: update PDF from Overleaf sources" || echo "No PDF changes"
          git push
